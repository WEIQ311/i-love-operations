# 服务器信息收集脚本使用说明

## 功能说明

该脚本可以批量收集多台服务器的CPU、内存、磁盘信息，并以JSON格式输出。

**特点：无需安装任何额外依赖，仅使用系统自带的SSH工具！**

## 认证方式

脚本使用 **SSH密钥认证** 方式，这是最安全、最快速的方式，且不需要安装任何额外工具。

## 使用步骤

### 第一步：配置SSH密钥（首次使用必须）

运行配置脚本来自动配置SSH密钥：

```bash
cd /path/to/server_monitor
./setup_ssh_key.sh
```

这个脚本会：
1. 检查是否已有SSH密钥，如果没有则自动生成
2. 自动将公钥复制到所有服务器（首次需要输入密码）
3. 测试所有服务器的连接

**手动配置方法（如果自动脚本不适用）：**

1. 生成SSH密钥（如果还没有）：
```bash
ssh-keygen -t rsa -b 2048
# 直接回车使用默认路径和空密码
```

2. 将公钥复制到所有服务器：
```bash
# 方法1：使用ssh-copy-id（推荐）
ssh-copy-id root@127.0.1.230

# 方法2：手动复制
cat ~/.ssh/id_rsa.pub | ssh root@127.0.1.230 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

3. 测试连接（应该不需要输入密码）：
```bash
ssh root@127.0.1.230
```

### 第二步：修改脚本配置

编辑 `collect_server_info.sh`，设置用户名：

```bash
USERNAME="root"  # 修改为您的用户名
```

### 第三步：执行脚本

```bash
./collect_server_info.sh
```

### 第四步：查看结果

结果保存在 `server_info.json` 文件中。

## 输出格式示例

```json
[
  {
    "ip": "127.0.1.230",
    "cpu_cores": 4,
    "cpu_usage": 25.5,
    "memory": {
      "total_gb": 16.00,
      "used_gb": 8.50,
      "free_gb": 7.50,
      "usage_percent": 53.12
    },
    "disk": {
      "total_gb": 100,
      "used_gb": 50,
      "free_gb": 50,
      "usage_percent": 50
    }
  }
]
```

## 优势

1. **无需额外依赖**：只使用系统自带的SSH工具
2. **安全性高**：使用SSH密钥认证，比密码更安全
3. **执行快速**：密钥认证比密码认证更快
4. **一次配置，永久使用**：配置好密钥后，以后都不需要输入密码

## 注意事项

1. 确保脚本有执行权限：
   ```bash
   chmod +x collect_server_info.sh setup_ssh_key.sh
   ```

2. 确保 `server_ip.txt` 文件存在且包含有效的IP地址

3. 首次配置SSH密钥时，需要输入每台服务器的密码（只需一次）

4. 脚本会跳过空行和以 `#` 开头的注释行

5. 如果服务器用户名不同，需要分别为不同用户配置SSH密钥

## 故障排查

### 1. SSH密钥未配置

**错误信息：** "警告: 未找到SSH密钥文件"

**解决方法：** 运行 `./setup_ssh_key.sh` 配置SSH密钥

### 2. 连接失败

**错误信息：** "无法连接到服务器或执行命令失败"

**可能原因：**
- SSH密钥未正确配置到该服务器
- 网络连接问题
- 服务器SSH服务未运行
- 用户名不正确

**解决方法：**
- 检查SSH连接：`ssh root@<IP地址>`
- 如果仍需要密码，重新运行 `./setup_ssh_key.sh`
- 检查网络连接和SSH服务状态

### 3. 命令执行失败

**可能原因：**
- 目标服务器缺少必要的命令（top, free, df等）
- 用户权限不足

**解决方法：**
- 检查服务器是否安装了必要的系统工具
- 确保用户有执行这些命令的权限

## 常见问题

**Q: 为什么必须使用SSH密钥？不能直接用密码吗？**

A: 使用密码需要额外的工具（如sshpass或expect），这些工具需要额外安装。SSH密钥是系统自带的功能，无需安装任何依赖，且更安全。

**Q: 配置SSH密钥后，还需要密码吗？**

A: 不需要。配置成功后，SSH连接将不再需要密码。

**Q: 如果服务器用户名不同怎么办？**

A: 需要分别为不同用户配置SSH密钥，或者修改脚本支持多用户。

**Q: 可以同时配置多个SSH密钥吗？**

A: 可以，SSH会自动尝试所有可用的密钥。
